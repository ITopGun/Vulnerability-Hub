#!/usr/bin/env python3
# -*- coding: utf-8 -*-

from fastapi.middleware.cors import CORSMiddleware
from fastapi import FastAPI, Request, Depends, HTTPException
from user import User, UserCreate, UserUpdate, UserDB, auth_backends, fastapi_users
from vulnerability import (
    create_vulnerability,
    fetch_all_vulnerabilities,
    update_vulnerability,
    fetch_one_vulnerability,
    remove_vulnerability,
)
from model import VulnerabilityOutput, VulnerabilityInput

# Initiating FastAPI Server
app = FastAPI()

# Managing CORS for the React Frontend connections
origins = ["*"]

app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"]
)


# --- User Authentication Routes Note ----------------------------------------------

# Learn more at https://frankie567.github.io/fastapi-users/configuration/routers/

# Add route for Login                           POST "/auth/login", "/auth/register"
app.include_router(
    fastapi_users.get_auth_router(auth_backends[0]),
    prefix="/auth",
    tags=["auth"]
)


def on_after_register(user: UserDB, request: Request):
    print("User {user.id} has registered.")


app.include_router(
    # fastapi_users.get_register_router(),
    fastapi_users.get_register_router(on_after_register),
    prefix="/auth",
    tags=["auth"]
)

# Add route for User utilities "/auth/users/*"

"""
    Get current logged in user profile          GET "/auth/users/me"
    Update current logged in user profile       PATCH "/auth/users/me"
    Get "_id" user profile                      GET "/auth/users/"
    Update "_id" user profile                   PATCH "/auth/users/{id}"
    Delete "_id" user profile                   DELETE "/auth/users/{id}"
"""

app.include_router(
    fastapi_users.get_users_router(),
    prefix="/auth/users",
    tags=["auth"]
)

# Add route for Reset Password utility

"""
    Forgot Password                             POST /auth/users/forgot-password
    Reset Password                              POST /auth/users/reset-password
"""

app.include_router(
    fastapi_users.get_reset_password_router("SECRET"),
    prefix="/auth/users",
    tags=["auth"]
)

# ----------------- Vulnerability CRUD urls --------------------------------


@app.get("/api/vulnerability", tags=["vulnerability solution crud"])
async def get_vulnerability(user: User = Depends(fastapi_users.get_current_user)):
    response = await fetch_all_vulnerabilities()
    return response


@app.post("/api/vulnerability/", response_model=VulnerabilityOutput, tags=["vulnerability solution crud"])
async def post_vulnerability(vulnerability: VulnerabilityInput, user: User = Depends(fastapi_users.get_current_user)):
    response = await create_vulnerability(vulnerability.dict())
    if not user.is_superuser:
        HTTPException(400, "You are not admin.")
    if response:
        return response
    raise HTTPException(400, "Something went wrong")


@app.put("/api/vulnerability/{id}/", response_model=VulnerabilityOutput, tags=["vulnerability solution crud"])
async def put_vulnerability(id: str, body: VulnerabilityInput, user: User = Depends(fastapi_users.get_current_user)):
    response = await update_vulnerability(id, body)
    if not user.is_superuser:
        HTTPException(400, "You are not admin.")
    if response:
        return response
    raise HTTPException(
        404, f"There is no vulnerability with the id {id}")


@app.get("/api/vulnerability/{id}", response_model=VulnerabilityOutput, tags=["vulnerability solution crud"])
async def get_vulnerability_by_id(id, user: User = Depends(fastapi_users.get_current_user)):
    response = await fetch_one_vulnerability(id)
    if response:
        return response
    raise HTTPException(
        404, f"There is no vulnerability with the id {id}")


@app.delete("/api/vulnerability/{id}", tags=["vulnerability solution crud"])
async def delete_vulnerability(id, user: User = Depends(fastapi_users.get_current_user)):
    response = await remove_vulnerability(id)
    if not user.is_superuser:
        HTTPException(400, "You are not admin.")
    if response:
        return {"result": True, "msg": "Successfully deleted vulnerability", "_id": id}
    raise HTTPException(
        404, f"There is no vulnerability with the id {id}")
